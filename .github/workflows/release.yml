name: Update CHANGELOG on PR Merge to Main

permissions:
  contents: write
  pull-requests: read

on:
  pull_request:
    types: [closed]
    branches:
      - main

# This is the critical fix for the race condition
concurrency:
  group: ${{ github.workflow }}-changelog
  cancel-in-progress: true

jobs:
  generate-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Generate or Update CHANGELOG
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          output-file: ./CHANGELOG.md
          preset: conventionalcommits
          
          # This tells the action to generate the changelog based on commits,
          # but not to create a new tag or version
          skip-tag: true
          skip-version-file: true
          
          # This tells the action to commit the file
          skip-commit: false 
          git-branch: main
          git-message: "docs(changelog): update CHANGELOG.md [skip ci]"
          git-user-name: "github-actions[bot]"
          git-user-email: "github-actions[bot]@users.noreply.github.com"

      # Removed the manual "Commit and Push" step.
      # The action above now handles it.
